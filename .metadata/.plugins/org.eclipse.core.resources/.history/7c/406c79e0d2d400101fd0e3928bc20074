<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.math.BigInteger" %>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ thống Chữ ký số ElGamal</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; color: #333; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #777; font-size: 14px; margin-bottom: 30px; }
        
        /* Layout 3 cột */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        /* Card Styles */
        .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; }
        .card-header { background: #6f42c1; color: #fff; padding: 15px; text-align: center; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .card-body { padding: 20px; flex-grow: 1; }
        
        /* Form Elements */
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px; }
        input[type="text"], textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace; }
        textarea { resize: vertical; min-height: 80px; }
        
        /* Buttons */
        .btn { border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; color: #fff; font-weight: bold; width: 100%; margin-bottom: 10px; transition: 0.2s; }
        .btn-primary { background-color: #4361ee; }
        .btn-success { background-color: #2ec4b6; }
        .btn-secondary { background-color: #6c757d; }
        .btn-dark { background-color: #343a40; }
        .btn:hover { opacity: 0.9; }
        
        .file-upload-wrapper { display: flex; gap: 10px; margin-bottom: 15px; }
        .file-upload-wrapper input[type="file"] { flex-grow: 1; }

        /* Kết quả */
        .result-box { background: #f8f9fa; border: 1px dashed #ccc; padding: 10px; font-size: 12px; color: #333; margin-top: 10px; word-break: break-all; }
        .alert { padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 14px; }
        .alert-success { background-color: #d4edda; color: #155724; }
        .alert-danger { background-color: #f8d7da; color: #721c24; }

        /* Footer */
        .footer-actions { margin-top: 20px; text-align: right; }
    </style>
    <script>
        // JS để đọc file text tại client và điền vào textarea
        function readFile(input, targetId) {
            let file = input.files[0];
            let reader = new FileReader();
            reader.onload = function() {
                document.getElementById(targetId).value = reader.result;
            };
            reader.readAsText(file);
        }
    </script>
</head>
<body>

<div class="container">
    <h1>Chữ Ký Số ElGamal</h1>
    <p class="subtitle">Hệ thống chữ ký số ElGamal - Thực hiện theo thứ tự từ bước 1 đến bước 3</p>

    <% if(request.getAttribute("error") != null) { %>
        <div class="alert alert-danger"><%= request.getAttribute("error") %></div>
    <% } %>

    <div class="grid-container">
        
        <div class="card">
            <div class="card-header" style="background: #6a5acd;">BƯỚC 1: TẠO KHÓA</div>
            <div class="card-body">
                <form action="process" method="post">
                    <input type="hidden" name="action" value="generateKeys">
                    
                    <label>Số nguyên tố p</label>
                    <input type="text" name="p" placeholder="Nhập p..." value="${sessionScope.key_p}">
                    
                    <label>Số căn nguyên alpha</label>
                    <input type="text" name="alpha" placeholder="Nhập alpha..." value="${sessionScope.key_alpha}">
                    
                    <label>Khóa bí mật x</label>
                    <input type="text" name="x" placeholder="Nhập x..." value="${sessionScope.key_x}">
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="reset" class="btn btn-secondary" style="width: 30%">Reset</button>
                        <button type="submit" name="genMode" value="input" class="btn btn-primary">Tạo khóa từ đầu vào</button>
                    </div>
                    <div style="text-align: center; margin: 10px 0;">hoặc</div>
                    <button type="submit" name="genMode" value="random" class="btn btn-success">Tạo khóa ngẫu nhiên</button>
                </form>

                <div class="result-box">
                    <strong>Khóa Đã Sinh:</strong><br>
                    <% if(session.getAttribute("key_y") != null) { %>
                        <span style="color: green">Đã có khóa!</span><br>
                        Public Key (y): ${sessionScope.key_y}<br>
                    <% } else { %>
                        Chưa có khóa được sinh.
                    <% } %>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="background: #6a5acd;">BƯỚC 2: KÝ TÀI LIỆU</div>
            <div class="card-body">
                <form action="process" method="post">
                    <input type="hidden" name="action" value="sign">
                    
                    <label>Văn bản cần ký</label>
                    <textarea name="docContent" id="docContent" placeholder="Nhập văn bản...">${param.docContent}</textarea>
                    
                    <div class="file-upload-wrapper">
                        <input type="file" onchange="readFile(this, 'docContent')">
                    </div>

                    <button type="submit" class="btn btn-primary">Ký tài liệu</button>
                </form>

                <div class="result-box">
                    <strong>Chữ Ký Đã Tạo (r, s):</strong><br>
                    <% if(request.getAttribute("sign_r") != null) { %>
                        r: <%= request.getAttribute("sign_r") %><br>
                        s: <%= request.getAttribute("sign_s") %>
                    <% } else { %>
                        Chữ ký sẽ hiển thị ở đây sau khi tạo...
                    <% } %>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="background: #6a5acd;">BƯỚC 3: XÁC MINH CHỮ KÝ</div>
            <div class="card-body">
                <form action="process" method="post">
                    <input type="hidden" name="action" value="verify">
                    
                    <label>Chữ ký (Điền dạng: r,s)</label>
                    <textarea name="sigVerifyR" id="sigVerify" placeholder="Nhập chữ ký r,s..."><% if(request.getAttribute("sign_r")!=null){ %><%=request.getAttribute("sign_r")%>,<%=request.getAttribute("sign_s")%><% } %></textarea>
                    <div class="file-upload-wrapper"><input type="file" onchange="readFile(this, 'sigVerify')"></div>

                    <label>Văn bản gốc</label>
                    <textarea name="docVerify" id="docVerify" placeholder="Nhập văn bản gốc...">${requestScope.last_signed_doc}</textarea>
                     <div class="file-upload-wrapper"><input type="file" onchange="readFile(this, 'docVerify')"></div>

                    <button type="submit" class="btn btn-primary">Xác minh chữ ký</button>
                </form>

                <div style="margin-top: 20px;">
                    <label>Kết Quả Kiểm Tra</label>
                    <% if(request.getAttribute("verify_checked") != null) { 
                        boolean isValid = (Boolean)request.getAttribute("verify_result");
                    %>
                        <div class="alert <%= isValid ? "alert-success" : "alert-danger" %>" style="text-align: center; font-weight: bold;">
                            <%= isValid ? "CHỮ KÝ HỢP LỆ" : "CHỮ KÝ KHÔNG HỢP LỆ / ĐÃ BỊ SỬA ĐỔI" %>
                        </div>
                    <% } else { %>
                        <div class="result-box">Chưa kiểm tra</div>
                    <% } %>
                </div>
            </div>
        </div>

    </div>

    <div class="footer-actions">
        <form action="process" method="post">
            <input type="hidden" name="action" value="reset">
            <button type="submit" class="btn btn-danger" style="background: #dc3545; width: auto;">Xóa tất cả dữ liệu</button>
        </form>
    </div>
</div>

</body>
</html>