<%@ page 
    language="java" 
    contentType="text/html; charset=UTF-8" 
    pageEncoding="UTF-8"
%>
<%@ page import="java.math.BigInteger" %>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Ch·ªØ k√Ω s·ªë ElGamal</title>
    
    <link rel="stylesheet" href="css/style.css">
    
    <script>
        function readFile(input, targetId) {
            let file = input.files[0];
            if (!file) return;
            
            let reader = new FileReader();
            reader.onload = function() {
                document.getElementById(targetId).value = reader.result;
            };
            reader.readAsText(file);
        }
    </script>
</head>
<body>

<div class="container">
    <h1>üîêCh·ªØ K√Ω S·ªë ElGamal</h1>
    <p class="subtitle">H·ªá th·ªëng ch·ªØ k√Ω s·ªë ElGamal - Th·ª±c hi·ªán theo th·ª© t·ª± t·ª´ b∆∞·ªõc 1 ƒë·∫øn b∆∞·ªõc 3</p>

    <% 
    if(request.getAttribute("error") != null) { 
    %>
        <div class="alert alert-danger">‚ùå <%= request.getAttribute("error") %></div>
    <% 
    } 
    %>
    
    <% 
    // L·∫•y ch·ªØ k√Ω t·ª´ session/request ƒë·ªÉ gi·ªØ l·∫°i sau verify
    String signR = (String) request.getAttribute("sign_r");
    String signS = (String) request.getAttribute("sign_s");
    String lastSignedDoc = (String) request.getAttribute("last_signed_doc");
    
    if (signR == null) {
        signR = (String) session.getAttribute("sign_r_session");
        signS = (String) session.getAttribute("sign_s_session");
    }
    if (lastSignedDoc == null) {
        lastSignedDoc = (String) session.getAttribute("last_signed_doc_session");
    }
    
    String docContentValue = (String) request.getParameter("docContent");
    if(docContentValue == null) {
        docContentValue = lastSignedDoc != null ? lastSignedDoc : "";
    }
    %>

    <div class="grid-container">
        
        <div class="card">
            <div class="card-header">B∆Ø·ªöC 1: T·∫†O KH√ìA</div>
            <div class="card-body">
                <form action="process" method="post">
                    <input type="hidden" name="action" value="generateKeys">
                    
                    <label>S·ªë nguy√™n t·ªë p</label>
                    <input type="text" name="p" placeholder="Nh·∫≠p s·ªë nguy√™n t·ªë p..." value="${sessionScope.key_p != null ? sessionScope.key_p : ''}">
                    
                    <label>S·ªë cƒÉn nguy√™n alpha</label>
                    <input type="text" name="alpha" placeholder="Nh·∫≠p s·ªë cƒÉn nguy√™n alpha..." value="${sessionScope.key_alpha != null ? sessionScope.key_alpha : ''}">
                    
                    <label>Kh√≥a b√≠ m·∫≠t x</label>
                    <input type="text" name="x" placeholder="Nh·∫≠p kh√≥a b√≠ m·∫≠t x..." value="${sessionScope.key_x != null ? sessionScope.key_x : ''}">
                    
                    <div class="button-group">
                        <button type="reset" class="btn btn-secondary" style="flex: 0 0 30%">X√≥a Form</button>
                        <button type="submit" name="genMode" value="input" class="btn btn-primary" style="flex: 1">T·∫°o kh√≥a t·ª´ ƒë·∫ßu v√†o</button>
                    </div>
                    
                    <div class="divider-text">ho·∫∑c</div>
                    
                    <button type="submit" name="genMode" value="random" class="btn btn-success">T·∫°o kh√≥a ng·∫´u nhi√™n</button>
                </form>

                <div class="result-box">
                    <strong>Kh√≥a ƒê√£ Sinh:</strong>
                    <% 
                    if(session.getAttribute("key_y") != null) { 
                    %>
                        <span class="success-text">Kh√≥a ƒê√£ T·∫°o Th√†nh C√¥ng!</span><br>
                        
                        <strong style="color: #667eea; margin-top: 10px; font-size: 13px;">Kh√≥a C√¥ng Khai (p, $\alpha$, y):</strong>
                        <span style="color: #555; display: block; margin-top: 5px;">p:</span>
                        <span style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">${sessionScope.key_p}</span>
                        
                        <span style="color: #555; display: block;">$\alpha$:</span>
                        <span style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">${sessionScope.key_alpha}</span>
                        
                        <span style="color: #555; display: block;">y:</span>
                        <span style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">${sessionScope.key_y}</span>
                        
                        <strong style="color: #eb3349; margin-top: 10px; font-size: 13px;">Kh√≥a B√≠ M·∫≠t (x):</strong>
                        <span style="color: #555; display: block; margin-top: 5px;">x:</span>
                        <span style="font-size: 12px; color: #666; display: block;">${sessionScope.key_x}</span>
                    <% 
                    } else { 
                    %>
                        <span style="color: #999">Ch∆∞a c√≥ kh√≥a ƒë∆∞·ª£c sinh.</span>
                    <% 
                    } 
                    %>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">B∆Ø·ªöC 2: K√ù T√ÄI LI·ªÜU</div>
            <div class="card-body">
                <form action="process" method="post">
                    <input type="hidden" name="action" value="sign">
                    
                    <label>VƒÉn b·∫£n c·∫ßn k√Ω</label>
                    <textarea name="docContent" id="docContent" placeholder="Nh·∫≠p vƒÉn b·∫£n c·∫ßn k√Ω..."><%= docContentValue %></textarea>
                    
                    <div class="file-upload-wrapper">
                        <input type="file" accept=".txt" onchange="readFile(this, 'docContent')">
                    </div>

                    <button type="submit" class="btn btn-primary">K√Ω t√†i li·ªáu</button>
                </form>

                <div class="result-box">
                    <strong>Ch·ªØ K√Ω ƒê√£ T·∫°o (r, s):</strong>
                    <% 
                    if(signR != null) { 
                    %>
                        <span style="color: #555">üìå r:</span><br>
                        <span style="font-size: 12px; color: #666; margin-bottom: 8px; display: block"><%= signR %></span>
                        <span style="color: #555">üìå s:</span><br>
                        <span style="font-size: 12px; color: #666"><%= signS %></span>
                    <% 
                    } else { 
                    %>
                        <span style="color: #999">Ch·ªØ k√Ω s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y sau khi t·∫°o...</span>
                    <% 
                    } 
                    %>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">B∆Ø·ªöC 3: X√ÅC MINH CH·ªÆ K√ù</div>
            <div class="card-body">
                <form action="process" method="post">
                    <input type="hidden" name="action" value="verify">
                    
                    <label>Ch·ªØ k√Ω (ƒêi·ªÅn d·∫°ng: r,s)</label>
                    <textarea name="sigVerifyR" id="sigVerify" placeholder="Nh·∫≠p ch·ªØ k√Ω d·∫°ng: r,s..."><%
                        if(request.getAttribute("verify_sig_input") != null){
                            out.print(request.getAttribute("verify_sig_input"));
                        } else if(signR != null){
                            out.print(signR + "," + signS);
                        }
                    %></textarea>
                    <div class="file-upload-wrapper">
                        <input type="file" accept=".txt" onchange="readFile(this, 'sigVerify')">
                    </div>

                    <label>VƒÉn b·∫£n g·ªëc</label>
                    <textarea name="docVerify" id="docVerify" placeholder="Nh·∫≠p vƒÉn b·∫£n g·ªëc..."><%
                        if(request.getAttribute("verify_doc_input") != null){
                            out.print(request.getAttribute("verify_doc_input"));
                        } else if (lastSignedDoc != null) {
                            out.print(lastSignedDoc);
                        }
                    %></textarea>
                    <div class="file-upload-wrapper">
                        <input type="file" accept=".txt" onchange="readFile(this, 'docVerify')">
                    </div>

                    <button type="submit" class="btn btn-primary">X√°c minh ch·ªØ k√Ω</button>
                </form>

                <div class="verify-result-section">
                    <label>K·∫øt Qu·∫£ Ki·ªÉm Tra</label>
                    <% 
                    if(request.getAttribute("verify_checked") != null) {
                        boolean isValid = (Boolean)request.getAttribute("verify_result");
                    %>
                        <div class="alert <%= isValid ? "alert-success" : "alert-danger" %> verify-result-box">
                            <%= isValid ? "CH·ªÆ K√ù H·ª¢P L·ªÜ" : "CH·ªÆ K√ù KH√îNG H·ª¢P L·ªÜ / ƒê√É B·ªä S·ª¨A ƒê·ªîI" %>
                        </div>
                    <% 
                    } else { 
                    %>
                        <div class="result-box">
                            <span style="color: #999">Ch∆∞a ki·ªÉm tra</span>
                        </div>
                    <% 
                    } 
                    %>
                </div>
            </div>
        </div>

    </div>

    </div>

</body>
</html>