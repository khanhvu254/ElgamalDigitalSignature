<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chữ Ký Số ElGamal - Có nút tạo k ngẫu nhiên</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 30px 0;
            font-family: 'Segoe UI', sans-serif;
        }
        .container { max-width: 1500px; }
        .card { border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 12px 35px rgba(0,0,0,0.3); }
        .card-header {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            padding: 20px;
            text-align: center;
        }
        .copy-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #555;
            cursor: pointer;
        }
        .copy-btn:hover { color: #000; }
        .verify-result {
            display: none;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            font-weight: bold;
            text-align: center;
            font-size: 1.8rem;
        }
        .verify-result.show { display: block; animation: fadeIn 0.6s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .signature-display {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .k-generator {
            background: linear-gradient(45deg, #ff9a9e, #fad0c4);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center text-white mb-5">
        <h1 class="display-3 fw-bold">CHỮ KÝ SỐ ELGAMAL</h1>
        <p class="lead fs-3">Hiển thị r, s, k • Cho phép k=1 • Có nút tạo k ngẫu nhiên</p>
    </div>

    <div class="row g-5">

        <!-- BƯỚC 1: TẠO KHÓA -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">BƯỚC 1: TẠO KHÓA</div>
                <div class="card-body">
                    <form action="keygen" method="post" class="mb-3">
                        <input type="hidden" name="type" value="manual">
                        <div class="mb-3">
                            <label class="form-label fw-bold">q (số nguyên tố)</label>
                            <input type="text" class="form-control" name="q" value="${sessionScope.lastQ}" placeholder="19" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">α (căn nguyên thủy)</label>
                            <input type="text" class="form-control" name="a" value="${sessionScope.lastA}" placeholder="10" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">x (khóa bí mật)</label>
                            <input type="text" class="form-control" name="x" value="${sessionScope.lastX}" placeholder="5" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mb-2">Tạo từ dữ liệu</button>
                    </form>

                    <form action="keygen" method="post">
                        <input type="hidden" name="type" value="auto">
                        <button type="submit" class="btn btn-success w-100">Tạo khóa ngẫu nhiên (70 bit)</button>
                    </form>

                    <c:if test="${sessionScope.keyGenerated == true}">
                        <div class="alert alert-success mt-4 text-center">
                            <strong>Khóa đã tạo thành công!</strong><br>
                            q = ${sessionScope.keyPair.q}<br>
                            α = ${sessionScope.keyPair.a}<br>
                            y = ${sessionScope.keyPair.y}<br>
                            <small class="text-danger">x = ${sessionScope.keyPair.x} (bí mật)</small>
                        </div>
                    </c:if>
                </div>
            </div>
        </div>

        <!-- BƯỚC 2: KÝ TÀI LIỆU -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">BƯỚC 2: KÝ TÀI LIỆU</div>
                <div class="card-body">
                    <c:if test="${not empty requestScope.error}">
                        <div class="alert alert-danger">${requestScope.error}</div>
                    </c:if>

                    <c:if test="${sessionScope.keyGenerated != true}">
                        <p class="text-muted text-center fst-italic">Vui lòng tạo khóa trước</p>
                    </c:if>

                    <c:if test="${sessionScope.keyGenerated == true}">
                        <form action="sign" method="post" enctype="multipart/form-data">
                            <textarea class="form-control mb-3" rows="6" name="message" placeholder="Nhập nội dung cần ký..." required>${requestScope.messageContent}</textarea>
                            <div class="text-center text-muted mb-2">HOẶC</div>
                            <input type="file" class="form-control mb-4" name="file">

                            <!-- PHẦN TẠO k NGẪU NHIÊN SIÊU ĐẸP -->
                            <div class="k-generator">
                                <h5 class="fw-bold text-white mb-3">
                                    <i class="fas fa-dice"></i> Tham số bí mật k
                                </h5>
                                <div class="row g-3 align-items-center">
                                    <div class="col-8">
                                        <input type="text" class="form-control form-control-lg text-center fw-bold" 
                                               name="customK" id="kInput" 
                                               placeholder="Nhấn nút bên phải để tạo k" 
                                               value="${param.customK}">
                                        <small class="text-white-50">Yêu cầu: 1 ≤ k ≤ q-2 và gcd(k,q-1)=1</small>
                                    </div>
                                    <div class="col-4">
                                        <button type="button" class="btn btn-warning btn-lg w-100 h-100 shadow-lg" 
                                                onclick="generateRandomK()">
                                            <i class="fas fa-dice-six fs-3"></i><br>
                                            <strong>Tạo k ngẫu nhiên</strong>
                                        </button>
                                    </div>
                                </div>
                                <small class="text-white mt-2 d-block">
                                    <em>Bạn có thể nhập k=1 để thấy r = α</em>
                                </small>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 btn-lg shadow">
                                <i class="fas fa-signature"></i> KÝ TÀI LIỆU
                            </button>
                        </form>

                        <!-- HIỂN THỊ CHỮ KÝ -->
                        <c:if test="${not empty requestScope.kValue}">
                            <div class="signature-display mt-4">
                                <h2 class="text-success fw-bold mb-4">CHỮ KÝ THÀNH CÔNG!</h2>
                                <div class="row text-center mb-4">
                                    <div class="col">
                                        <h1 class="text-danger fw-bold">r = ${requestScope.rValue}</h1>
                                    </div>
                                    <div class="col">
                                        <h1 class="text-primary fw-bold">s = ${requestScope.sValue}</h1>
                                    </div>
                                    <div class="col">
                                        <h1 class="text-warning fw-bold">k = ${requestScope.kValue}</h1>
                                    </div>
                                </div>
                                <hr class="bg-white">
                                <p class="fs-5 text-white fw-bold mb-2">
                                    Chữ ký đầy đủ (r,s,k):
                                </p>
                                <h4 class="text-dark bg-white rounded px-4 py-2 d-inline-block">
                                    ${requestScope.signatureText}
                                </h4>
                                <button class="copy-btn" onclick="copyText('${requestScope.signatureText}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <button onclick="downloadSignature()" class="btn btn-success w-100 mt-3 btn-lg">
                                <i class="fas fa-download"></i> Tải chữ ký (r,s,k).txt
                            </button>
                        </c:if>
                    </c:if>
                </div>
            </div>
        </div>

        <!-- BƯỚC 3: XÁC MINH -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">BƯỚC 3: XÁC MINH CHỮ KÝ</div>
                <div class="card-body">
                    <c:if test="${sessionScope.keyGenerated != true}">
                        <p class="text-muted text-center fst-italic">Vui lòng tạo khóa trước</p>
                    </c:if>

                    <c:if test="${sessionScope.keyGenerated == true}">
                        <div id="verifyResult" class="verify-result"></div>

                        <form id="verifyManualForm">
                            <h6 class="text-success fw-bold">Nhập tay r, s và thông điệp</h6>
                            <input type="text" class="form-control mb-2" id="rInput" placeholder="Nhập r" required>
                            <input type="text" class="form-control mb-2" id="sInput" placeholder="Nhập s" required>
                            <textarea class="form-control mb-3" rows="4" id="messageInput" placeholder="Dán nội dung gốc..." required></textarea>
                            <button type="submit" class="btn btn-primary w-100">XÁC MINH NGAY</button>
                        </form>
                    </c:if>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// TẠO k NGẪU NHIÊN HỢP LỆ (dùng BigInt chuẩn JS hiện đại)
function generateRandomK() {
    const qStr = "${sessionScope.keyPair.q}";
    if (!qStr || qStr === '') {
        alert("Chưa tạo khóa!");
        return;
    }

    const q = BigInt(qStr);
    const max = q - 2n;
    let attempts = 0;

    const interval = setInterval(() => {
        if (attempts > 1000) {
            clearInterval(interval);
            alert("Không tìm được k phù hợp!");
            return;
        }

        const k = 1n + BigInt(Math.floor(Math.random() * Number(max)));
        if (gcd(k, q - 1n) === 1n) {
            document.getElementById('kInput').value = k.toString();
            clearInterval(interval);
            alert("ĐÃ TẠO k HỢP LỆ:\n\nk = " + k);
        }
        attempts++;
    }, 1);
}

function gcd(a, b) {
    while (b !== 0n) {
        [a, b] = [b, a % b];
    }
    return a;
}

// Copy, download, verify...
function copyText(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert("Đã sao chép: " + text);
    });
}

function downloadSignature() {
    const text = "${requestScope.signatureText}";
    if (!text) return alert("Chưa có chữ ký!");
    const blob = new Blob([text], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "chuky_elgamal_r_s_k.txt";
    a.click();
    URL.revokeObjectURL(url);
}

// Xác minh
document.getElementById('verifyManualForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData();
    fd.append('r', document.getElementById('rInput').value.trim());
    fd.append('s', document.getElementById('sInput').value.trim());
    fd.append('message', document.getElementById('messageInput').value);

    const res = await fetch('verify', { method: 'POST', body: fd });
    const html = await res.text();
    const isValid = html.includes('valid">true');

    const el = document.getElementById('verifyResult');
    el.className = 'verify-result show ' + (isValid ? 'alert-success' : 'alert-danger');
    el.innerHTML = isValid 
        ? '<i class="fas fa-check-circle"></i> CHỮ KÝ HỢP LỆ!' 
        : '<i class="fas fa-times-circle"></i> CHỮ KÝ KHÔNG HỢP LỆ!';
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>