<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.math.BigInteger" %>
<%@ page import="java.util.List" %>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ thống Chữ ký số ElGamal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px 0; }
        .card { transition: all 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
        .card-header { background: linear-gradient(45deg, #6a5acd, #836fff) !important; font-size: 1.1rem; }
        textarea, input[type=text] { font-family: 'Courier New', monospace; font-size: 0.95rem; }
        .history-item { font-size: 0.9rem; padding: 10px 0; border-bottom: 1px dashed #ddd; }
        .history-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-primary">Chữ Ký Số ElGamal</h1>
        <p class="text-muted">Hệ thống minh họa thuật toán chữ ký số ElGamal - Java Web</p>
    </div>

    <!-- Thông báo lỗi -->
    <% if(request.getAttribute("error") != null) { %>
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Lỗi:</strong> <%= request.getAttribute("error") %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <div class="row g-4">
        <!-- BƯỚC 1: TẠO KHÓA -->
        <div class="col-lg-4">
            <div class="card shadow h-100">
                <div class="card-header text-white text-center fw-bold">BƯỚC 1: TẠO KHÓA</div>
                <div class="card-body d-flex flex-column">
                    <form action="process" method="post">
                        <input type="hidden" name="action" value="generateKeys">

                        <div class="mb-3">
                            <label class="form-label fw-bold">Số nguyên tố p</label>
                            <input type="text" class="form-control" name="p" placeholder="Nhập p (nguyên tố lớn)"
                                   value="<%= session.getAttribute("key_p") != null ? session.getAttribute("key_p") : "" %>">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Căn nguyên alpha</label>
                            <input type="text" class="form-control" name="alpha" placeholder="Nhập alpha"
                                   value="<%= session.getAttribute("key_alpha") != null ? session.getAttribute("key_alpha") : "" %>">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Khóa bí mật x</label>
                            <input type="text" class="form-control" name="x" placeholder="Nhập x (bí mật)"
                                   value="<%= session.getAttribute("key_x") != null ? session.getAttribute("key_x") : "" %>">
                        </div>

                        <div class="d-grid gap-2">
                            <div class="row">
                                <div class="col-6">
                                    <button type="reset" class="btn btn-outline-secondary w-100">Reset</button>
                                </div>
                                <div class="col-6">
                                    <button type="submit" name="genMode" value="input" class="btn btn-primary w-100">Tạo từ input</button>
                                </div>
                            </div>
                            <button type="submit" name="genMode" value="random" class="btn btn-success w-100">
                                Tạo khóa ngẫu nhiên (512-bit)
                            </button>
                        </div>
                    </form>

                    <hr>
                    <div class="text-center">
                        <% if(session.getAttribute("key_y") != null) { %>
                            <div class="alert alert-success py-2">
                                <strong>Đã tạo khóa thành công!</strong>
                            </div>
                            <small class="text-muted">Public key (y):</small><br>
                            <code class="text-primary"><%= session.getAttribute("key_y") %></code>
                        <% } else { %>
                            <p class="text-muted mb-0">Chưa có khóa. Vui lòng tạo khóa ở trên.</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- BƯỚC 2: KÝ TÀI LIỆU -->
        <div class="col-lg-4">
            <div class="card shadow h-100">
                <div class="card-header text-white text-center fw-bold">BƯỚC 2: KÝ TÀI LIỆU</div>
                <div class="card-body d-flex flex-column">
                    <form action="process" method="post">
                        <input type="hidden" name="action" value="sign">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nội dung cần ký</label>
                            <textarea class="form-control" name="docContent" rows="6" placeholder="Nhập văn bản cần ký..."><%= 
                                session.getAttribute("last_signed_doc") != null ? session.getAttribute("last_signed_doc") : ""
                            %></textarea>
                        </div>
                        <div class="mb-3">
                            <input type="file" class="form-control form-control-sm" accept=".txt" onchange="readFile(this, 'textarea[name=docContent]')">
                            <small class="text-muted">Hoặc tải file .txt</small>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg w-100">Ký Tài Liệu</button>
                    </form>

                    <hr>
                    <strong>Chữ ký số (r, s):</strong>
                    <% if(session.getAttribute("sign_r") != null) { %>
                        <div class="bg-light p-3 rounded mt-2 border">
                            <small>r:</small><br>
                            <code class="text-danger"><%= session.getAttribute("sign_r") %></code><br><br>
                            <small>s:</small><br>
                            <code class="text-danger"><%= session.getAttribute("sign_s") %></code>
                        </div>
                    <% } else { %>
                        <p class="text-muted text-center mt-3">Chưa có chữ ký</p>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- BƯỚC 3: XÁC MINH -->
        <div class="col-lg-4">
            <div class="card shadow h-100">
                <div class="card-header text-white text-center fw-bold">BƯỚC 3: XÁC MINH CHỮ KÝ</div>
                <div class="card-body d-flex flex-column">
                    <form action="process" method="post">
                        <input type="hidden" name="action" value="verify">

                        <div class="mb-3">
                            <label class="form-label fw-bold">Chữ ký (dạng r,s)</label>
                            <textarea class="form-control" name="sigVerifyR" rows="3" placeholder="Dán r,s vào đây..."><%
                                if (session.getAttribute("sign_r") != null) {
                                    out.print(session.getAttribute("sign_r") + "," + session.getAttribute("sign_s"));
                                }
                            %></textarea>
                        </div>
                        <div class="mb-3">
                            <input type="file" class="form-control form-control-sm" accept=".txt" onchange="readFile(this, 'textarea[name=sigVerifyR]')">
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Văn bản gốc</label>
                            <textarea class="form-control" name="docVerify" rows="6" placeholder="Dán văn bản gốc..."><%= 
                                session.getAttribute("last_signed_doc") != null ? session.getAttribute("last_signed_doc") : ""
                            %></textarea>
                        </div>
                        <div class="mb-3">
                            <input type="file" class="form-control form-control-sm" accept=".txt" onchange="readFile(this, 'textarea[name=docVerify]')">
                        </div>

                        <button type="submit" class="btn btn-warning btn-lg w-100 text-dark fw-bold">Xác Minh Ngay</button>
                    </form>

                    <!-- Kết quả xác minh -->
                    <div class="mt-4 text-center">
                        <% if(session.getAttribute("verify_checked") != null) {
                            boolean valid = (Boolean) session.getAttribute("verify_result"); %>
                            <div class="alert <%= valid ? "alert-success" : "alert-danger" %> fw-bold fs-5">
                                <%= valid ? "CHỮ KÝ HỢP LỆ" : "CHỮ KÝ KHÔNG HỢP LỆ" %>
                            </div>
                        <% } else { %>
                            <p class="text-muted">Chưa thực hiện xác minh</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LỊCH SỬ + XÓA DỮ LIỆU -->
    <div class="mt-5">
        <div class="card shadow border-0">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">QUẢN LÝ PHIÊN & LỊCH SỬ</h5>
                <form action="process" method="post" class="mb-0">
                    <input type="hidden" name="action" value="reset">
                    <button type="submit" class="btn btn-light btn-sm fw-bold">Xóa Toàn Bộ Dữ Liệu</button>
                </form>
            </div>
            <div class="card-body">
                <h6 class="fw-bold text-primary mb-3">Lịch sử xác minh chữ ký</h6>
                <%
                    List<String> history = (List<String>) session.getAttribute("verify_history");
                    if (history != null && !history.isEmpty()) {
                        for (String entry : history) {
                            out.println("<div class=\"history-item\">" + entry + "</div>");
                        }
                    } else {
                        out.println("<p class=\"text-muted text-center\">Chưa có hoạt động xác minh nào.</p>");
                    }
                %>
            </div>
        </div>
    </div>
</div>

<script>
    function readFile(input, targetSelector) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.querySelector(targetSelector).value = e.target.result;
            };
            reader.readAsText(file);
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>