package controller;

import model.ElgamalModel;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.*;
import java.io.IOException;
import java.math.BigInteger;
import java.util.Date;

@WebServlet("/process")
public class ElgamalServlet extends HttpServlet {

    private ElgamalModel model = new ElgamalModel();

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        req.setCharacterEncoding("UTF-8");
        String action = req.getParameter("action");
        HttpSession session = req.getSession();

        try {
            switch (action) {
                case "generateKeys":
                    handleGenerateKeys(req, session);
                    break;
                case "sign":
                    handleSign(req, session);
                    break;
                case "verify":
                    handleVerify(req, session);
                    break;
                case "reset":
                    session.invalidate();
                    session = req.getSession(); // tạo session mới để tránh lỗi
                    break;
            }
        } catch (Exception e) {
            req.setAttribute("error", "Lỗi xử lý: " + e.getMessage());
        }

        req.getRequestDispatcher("index.jsp").forward(req, resp);
    }

    private void handleGenerateKeys(HttpServletRequest req, HttpSession session) {
        String mode = req.getParameter("genMode");

        BigInteger p, alpha, x, y;

        if ("random".equals(mode)) {
            BigInteger[] keys = model.generateKeys(512);
            p = keys[0]; alpha = keys[1]; x = keys[2]; y = keys[3];
        } else {
            p = new BigInteger(req.getParameter("p"));
            alpha = new BigInteger(req.getParameter("alpha"));
            x = new BigInteger(req.getParameter("x"));
            y = alpha.modPow(x, p);
        }

        session.setAttribute("key_p", p);
        session.setAttribute("key_alpha", alpha);
        session.setAttribute("key_x", x);
        session.setAttribute("key_y", y);

        session.setAttribute("msg_gen", "Đã tạo khóa thành công!");
    }

    private void handleSign(HttpServletRequest req, HttpSession session) throws Exception {
        BigInteger p = (BigInteger) session.getAttribute("key_p");
        BigInteger alpha = (BigInteger) session.getAttribute("key_alpha");
        BigInteger x = (BigInteger) session.getAttribute("key_x");

        if (p == null || x == null) {
            req.setAttribute("error", "Chưa có khóa! Vui lòng tạo khóa ở Bước 1.");
            return;
        }

        String docContent = req.getParameter("docContent");
        if (docContent == null || docContent.trim().isEmpty()) {
            req.setAttribute("error", "Vui lòng nhập hoặc tải lên văn bản cần ký.");
            return;
        }

        String[] signature = model.sign(docContent, p, alpha, x);

        // Lưu vào cả request (hiển thị ngay) và session (giữ lại sau khi verify)
        req.setAttribute("sign_r", signature[0]);
        req.setAttribute("sign_s", signature[1]);
        req.setAttribute("last_signed_doc", docContent);

        session.setAttribute("last_sign_r", signature[0]);
        session.setAttribute("last_sign_s", signature[1]);
        session.setAttribute("last_signed_doc", docContent);

        // Bonus: thêm lịch sử hoạt động
        String history = (String) session.getAttribute("history");
        String time = new Date().toString();
        String shortR = signature[0].toString();
        if (shortR.length() > 40) shortR = shortR.substring(0, 40) + "...";

        String entry = "[" + time + "] Ký văn bản (" + docContent.length() + " ký tự) → r = " + shortR + "\n";
        session.setAttribute("history", (history == null ? "" : history) + entry);
    }

    private void handleVerify(HttpServletRequest req, HttpSession session) {
        BigInteger p = (BigInteger) session.getAttribute("key_p");
        BigInteger alpha = (BigInteger) session.getAttribute("key_alpha");
        BigInteger y = (BigInteger) session.getAttribute("key_y");

        if (p == null) {
            req.setAttribute("error", "Không tìm thấy Public Key trong phiên làm việc.");
            return;
        }

        String docVerify = req.getParameter("docVerify");
        String sigR = req.getParameter("sigVerifyR");

        if (sigR == null || sigR.trim().isEmpty() || docVerify == null) {
            req.setAttribute("error", "Vui lòng nhập đầy đủ chữ ký và văn bản.");
            return;
        }

        // Hỗ trợ cả dạng "r,s" và "r , s" hoặc chỉ r (s ở ô khác – nhưng ở đây dùng 1 ô)
        String rStr = sigR.trim();
        String sStr = "";
        if (rStr.contains(",")) {
            String[] parts = rStr.split(",");
            rStr = parts[0].trim();
            sStr = parts[1].trim();
        } else {
            // nếu người dùng chỉ dán r, có thể lấy từ session cũ
            if ("".equals(sStr) && session.getAttribute("last_sign_s") != null) {
                sStr = session.getAttribute("last_sign_s").toString();
            }
        }

        boolean isValid = model.verify(docVerify, rStr, sStr, p, alpha, y);
        req.setAttribute("verify_result", isValid);
        req.setAttribute("verify_checked", true);
    }
}