<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.math.BigInteger" %>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ thống Chữ ký số ElGamal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css"> 
    
    <script>
        // JS để đọc file text tại client và điền vào textarea
        function readFile(input, targetId) {
            let file = input.files[0];
            let reader = new FileReader();
            reader.onload = function() {
                document.getElementById(targetId).value = reader.result;
            };
            reader.readAsText(file);
        }
    </script>
</head>
<body>

<div class="container">
    <div class="text-center text-white mb-5">
        <h1 class="display-4 fw-bold">CHỮ KÝ SỐ ELGAMAL</h1>
        <p class="lead">Demo theo cấu trúc Model-Servlet</p>
    </div>

    <% 
        // Hiển thị lỗi nếu có
        if(request.getAttribute("error") != null) { 
    %>
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Lỗi!</h4>
            <p><%= request.getAttribute("error") %></p>
        </div>
    <% 
        } 
        // Khởi tạo biến tiện ích
        BigInteger p = (BigInteger)session.getAttribute("key_p");
        BigInteger y = (BigInteger)session.getAttribute("key_y");
        String signedDoc = (String)request.getAttribute("last_signed_doc");
    %>


    <div class="row g-5">
        
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">BƯỚC 1: TẠO KHÓA</div>
                <div class="card-body">
                    <form action="process" method="post" class="mb-3">
                        <input type="hidden" name="action" value="generateKeys">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Số nguyên tố p</label>
                            <input type="text" class="form-control" name="p" placeholder="Nhập p..." value="${sessionScope.key_p}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Số căn nguyên alpha</label>
                            <input type="text" class="form-control" name="alpha" placeholder="Nhập alpha..." value="${sessionScope.key_alpha}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Khóa bí mật x</label>
                            <input type="text" class="form-control" name="x" placeholder="Nhập x..." value="${sessionScope.key_x}">
                        </div>
                        
                        <div class="d-grid d-md-flex gap-2 mb-3">
                            <button type="submit" name="genMode" value="input" class="btn btn-primary flex-fill">Tạo khóa từ đầu vào</button>
                        </div>
                        <button type="submit" name="genMode" value="random" class="btn btn-success w-100">Tạo khóa ngẫu nhiên (512 bit)</button>
                    </form>

                    <div class="result-box mt-4">
                        <strong class="text-primary">Khóa Công Khai (p, $\alpha$, y):</strong><br>
                        <% if(y != null) { %>
                            <div class="mt-2 fw-bold text-success">Đã có khóa!</div>
                            p: ${sessionScope.key_p}<br>
                            $\alpha$: ${sessionScope.key_alpha}<br>
                            y: ${sessionScope.key_y}
                            <button class="copy-btn" onclick="copyText('p:${sessionScope.key_p}, a:${sessionScope.key_alpha}, y:${sessionScope.key_y}')"><i class="fas fa-copy"></i></button>
                        <% } else { %>
                            Chưa có khóa được sinh.
                        <% } %>
                    </div>
                    
                    <div class="result-box mt-3 bg-danger-subtle">
                         <strong class="text-danger">Khóa Bí Mật (x):</strong>
                         <div class="mt-2 fw-bold text-danger">
                             <% if(session.getAttribute("key_x") != null) { %>
                                ${sessionScope.key_x}
                                <button class="copy-btn" onclick="copyText('${sessionScope.key_x}')"><i class="fas fa-copy"></i></button>
                             <% } else { %>
                                (Chưa có)
                             <% } %>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">BƯỚC 2: KÝ TÀI LIỆU</div>
                <div class="card-body">
                    <% if(p == null) { %>
                        <p class="text-muted text-center fst-italic">Vui lòng tạo khóa trước</p>
                    <% } else { %>
                        <form action="process" method="post">
                            <input type="hidden" name="action" value="sign">
                            
                            <label class="form-label fw-bold">Văn bản cần ký</label>
                            <textarea class="form-control mb-3" rows="6" name="docContent" id="docContent" placeholder="Nhập nội dung cần ký..." required><%= (signedDoc != null) ? signedDoc : "" %></textarea>
                            
                            <div class="text-center text-muted mb-2">HOẶC</div>
                            <input type="file" class="form-control mb-3" onchange="readFile(this, 'docContent')">

                            <button type="submit" class="btn btn-primary w-100 btn-lg">Ký tài liệu</button>
                        </form>

                        <% if(request.getAttribute("sign_r") != null) { %>
                            <div class="result-box mt-4 signature-display text-center">
                                <strong class="text-success d-block mb-3">CHỮ KÝ THÀNH CÔNG!</strong>
                                <div class="fs-4 fw-bold text-primary">r = <%= request.getAttribute("sign_r") %></div>
                                <div class="fs-4 fw-bold text-primary">s = <%= request.getAttribute("sign_s") %></div>
                                <hr>
                                <div class="small text-muted">Chữ ký (r,s): <%= request.getAttribute("sign_r") %>,<%= request.getAttribute("sign_s") %></div>
                                <button class="copy-btn" onclick="copyText('<%= request.getAttribute("sign_r") %>,<%= request.getAttribute("sign_s") %>')"><i class="fas fa-copy"></i></button>
                            </div>
                        <% } %>
                    <% } %>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">BƯỚC 3: XÁC MINH CHỮ KÝ</div>
                <div class="card-body">
                    <% if(p == null) { %>
                        <p class="text-muted text-center fst-italic">Vui lòng tạo khóa trước</p>
                    <% } else { %>
                        <% 
                            Boolean verifyChecked = (Boolean)request.getAttribute("verify_checked");
                            if (verifyChecked != null && verifyChecked) {
                                boolean isValid = (Boolean)request.getAttribute("verify_result");
                                String resultClass = isValid ? "alert-success" : "alert-danger";
                                String bgColor = isValid ? "#d1e7dd" : "#f8d7da";
                                String textColor = isValid ? "#0f5132" : "#842029";
                                String message = isValid ? "CHỮ KÝ HỢP LỆ" : "CHỮ KÝ KHÔNG HỢP LỆ";
                        %>
                            <div id="verifyResult" class="verify-result show" style="background-color: <%= bgColor %>; color: <%= textColor %>;">
                                <%= message %>
                            </div>
                        <%
                            } else {
                        %>
                            <div id="verifyResult" class="verify-result"></div>
                        <%
                            }
                        %>
                        
                        <form action="process" method="post">
                            <input type="hidden" name="action" value="verify">
                            
                            <label class="form-label fw-bold mt-2">Chữ ký (r,s)</label>
                            <textarea class="form-control mb-2" rows="2" name="sigVerifyR" id="sigVerifyR" placeholder="Nhập chữ ký r,s..."><%
                                if(request.getAttribute("sign_r") != null) {
                                    out.print(request.getAttribute("sign_r") + "," + request.getAttribute("sign_s"));
                                }
                            %></textarea>
                            <input type="file" class="form-control mb-3" onchange="readFile(this, 'sigVerifyR')">
                            
                            <label class="form-label fw-bold">Văn bản gốc</label>
                            <textarea class="form-control mb-3" rows="3" name="docVerify" id="docVerify" placeholder="Nhập văn bản gốc..."><%= (signedDoc != null) ? signedDoc : "" %></textarea>
                            <input type="file" class="form-control mb-3" onchange="readFile(this, 'docVerify')">
                            
                            <button type="submit" class="btn btn-primary w-100 mt-3">Xác minh</button>
                        </form>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12 text-center">
            <form action="process" method="post">
                <input type="hidden" name="action" value="reset">
                <button type="submit" class="btn btn-danger btn-lg" onclick="return confirm('Bạn có chắc chắn muốn XÓA TẤT CẢ KHÓA và dữ liệu phiên làm việc không?');">
                    <i class="fas fa-trash"></i> Xóa tất cả dữ liệu (Reset Session)
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // Hàm copy text (Giữ nguyên)
    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert("Đã sao chép: " + text.substring(0, 50) + "...");
        }).catch(err => {
            console.error('Không thể sao chép: ', err);
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>